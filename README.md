# これは何？
とある列車運転ソフトウェアと連動して、以下のタイミングで音声を再生します。

1. 停車後～発車まで
	1. 発車メロディ
	1. 発車時アナウンス
1. 発車後すぐ
	1. 発車時車内アナウンス
1. 次駅到着直前
	1. 到着前車内アナウンス

# 必要なもの
各タイミングで鳴らす音声データ（wav形式に限る）。付属しませんので、ご利用の方が準備してください。

# 動作に必要な環境
- Anaconda 3（Anaconda3-2022.10-Windows-x86_64.exe にて動作確認）
	- https://www.anaconda.com/products/distribution
- Tesseract-OCR（tesseract-ocr-w64-setup-v5.2.0.20220712.exe にて動作確認）
	- https://github.com/UB-Mannheim/tesseract/wiki
- その他、Pythonコミュニティより提供されるモジュールを複数
	- 環境準備項で必要なものを記載

# 事前準備
本項目は、当方環境でうまく動いたセットアップを記載しているものであり、これで確実に動作するという保証をするものではないです。

1. Anaconda 3およびTesseract-OCRをダウンロードし、インストールを実施する
	1. Anaconda 3のインストール時はPATHを通すオプションを有効にしてください
	1. Tesseract-OCRでは追加の言語パックがありますがアルファベットと数字しか読み取りませんので不要です
		1. Tesseract-OCRのインストール作業中、インストール先のPATHが表示されるの、でjrets.py内の「Tesseract-OCR初期設定」にある2箇所のパス情報を置き換えます
1. コマンドプロンプトを開き、以下のコマンドを実行、追加のモジュールを導入する　※他はバンドルで入ってる筈
	1. pip install pyocr
	1. pip install playsound==1.2.2
1. 後述の内容に従い、音声データを準備する
	1. 後述の内容に従い、音声データを指定するCSVファイルを作成する
1. 列車運転ソフトウェアのインストールフォルダ内にある「Station.dll」を適当な名前にリネームするか別の場所へ移動する

# 使い方
1. 本スクリプトと、事前準備した音声データ、CSVを同じフォルダに置きます
1. コマンドプロンプトを起動し、スクリプトを置いたフォルダに移動します
1. python jrets.pyとコマンドを入力します
1. 操作画面が表示されるので、参照からCSVファイルを読み込み、走行する形式と始発駅、接近時音声の再生距離を選択します
1. 開始ボタンを押した後、列車運転ソフトウェアを起動し、選択した始発駅から走行を開始します
1. それっぽい雰囲気で音声が流れる筈です

接近時音声の再生距離は路線事情により適切な値が異なる為、選択制にしています。東海道線を走った感覚では、750で指定するのが良いのではないかと思いますが、今後のDLC次第で変わってくると思います。

尚、停止ボタンを押すことで音声再生部を停止しますが、停止命令が即座に反映される仕組みではない形で停止しているので、完全停止までに想定外の音声が流れる場合があります。実装の都合なので、完全停止を即座に実施したい場合はコマンドプロンプトを閉じてください。

# 仕組み
本アプリケーションは、OCRという技術により、列車運転ソフトウェア上に表示されている文字列を取得することで、今、列車がどの様な状況にあるかをチェックし、状況に応じた音声を再生することを実現しています。こんなカンタンにOCRを使えるライブラリを無償提供して頂いている技術者の方々に感謝。

読み取り精度と負荷軽減対策の関係で、読み取り成功のタイミングがまちまちになる為、放送タイミングが若干ずれることがありますが、画面情報だけでどうにか出来る限界です。運転の雰囲気を上げるもの、って程度で捉えてください。列車運転ソフトウェア側のメモリ解析とか出来ればこんな悪手必要ないんですけど、作者にはそんな力がない為、力技で解決しています。

尚、停車・発車は文字列だけでは判断が出来なかった為、一部の処理は戸閉灯の明度を拾って対応しています。最も引きの状態（デフォルト状態）で運転台が表示された状態での運転が必要になります。アップ状態での表示がお好みでしたら、スクリプト中の位置座標を手直ししてください。運転台非表示では使えません。

# CSVファイルの仕様
フォーマットは「次駅名アルファベット,残距離,発車時音声,駅接近時音声,発車メロディ,発車案内,発時刻」とする必要があります。

「Station,Distance,Nextfile,Soonfile,Chime,Voice,Dept」のヘッダを1行目に付けてください。これがデータ読み込み時の目印として使われますので、必ず入れてください。

- 次駅名アルファベット：右上の次駅名表示に表示される書式で次の駅を記載します。
- 残距離：発車直後に再生される音声を再生する距離を記載、駅間距離から20m位引いた値だとちょうど良いと思います。
- 発車時音声：発車直後に再生される音声のファイル名を記載します。
- 駅接近時音声：到着直前に再生される音声のファイル名を記載します。
- 発車メロディ：指定した次駅で流れる発車メロディ音声のファイル名を記載します。
- 発車案内：発車メロディの後に流れる「ドア閉まります、ご注意ください」の音声ファイル名を記載します。
- 発時刻：ダイヤ上の発時刻を「12:00:00」の書式で記載します。

サンプルとして、標準パックで搭載されている東海道線2区間分で使えるファイルtokaido.csvを同梱しますので、書き方の参考にしてみてください。

尚、始発駅は「Station」「Chime,Voice,Dept」の部分のみの使用です。

# 音声ファイルの仕様
## ファイル形式
使用しているライブラリの都合上、使えるものはwav形式のみとなります。非圧縮ファイルなのでサイズは大きいですが、短い音声だけなのであまり問題はないと思います。

## 発車案内
発車案内は田中氏・向井氏の共通化ファイルにして、駅ごとに発車メロディだけ入れ替える、という設計思想で、発車メロディと発車案内は別ファイルに分ける形にしています。作成者の好みなので、不満な場合は適宜修正してください。尚、「次の列車をご利用ください」の音声が入ったファイルである前提で、再生タイミングを調整しています。

## 発車メロディの長さ
音声ファイルの長さを確認してよきタイミングで再生するようにしていますが、駅停車時間の総時間が原則30秒となっているので、発車メロディと発車案内が合計22秒くらいでないと収まりが悪くなります。ワンコーラスでは収まらない曲については、適宜ぶった切って調整してください。

# ライセンス
Copyright (c) 2022 devicehigh

以下に定める条件に従い、本ソフトウェアおよび関連文書のファイル（以下「ソフトウェア」）の複製を取得するすべての人に対し、ソフトウェアを無制限に扱うことを無償で許可します。これには、ソフトウェアの複製を使用、複写、変更、結合、掲載、頒布、サブライセンス、および/または販売する権利、およびソフトウェアを提供する相手に同じことを許可する権利も無制限に含まれます。ただし、本ソフトウェアの使用中の動画を公開することは、本ソフトウェアの改編版の使用中のものも含め、禁止します。

上記の著作権表示および本許諾表示を、ソフトウェアのすべての複製または重要な部分に記載するものとします。

ソフトウェアは「現状のまま」で、明示であるか暗黙であるかを問わず、何らの保証もなく提供されます。ここでいう保証とは、商品性、特定の目的への適合性、および権利非侵害についての保証も含みますが、それに限定されるものではありません。 作者または著作権者は、契約行為、不法行為、またはそれ以外であろうと、ソフトウェアに起因または関連し、あるいはソフトウェアの使用またはその他の扱いによって生じる一切の請求、損害、その他の義務について何らの責任も負わないものとします。 

## ようは
MIT Licenseとしたいところでしたが、とある列車運転ソフトウェアに関するとある配信でのお話を鑑み、このスクリプトが実現出来ることがさも実装されているかのように見えてしまうことは良くないことであると考え、動画公開のみ、禁止とするライセンスとさせて頂きます。動画配信者の方はご注意くださいませ。
